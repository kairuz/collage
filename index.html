<html>
<head>
  <style>
    * {
      font-family: monospace;
      font-weight: bold;
    }

  </style>
  <script>

    let pSampleBuffers = null;
    let pScheduler = null;
    let pBarUis = null;
  </script>
  <script type="module">

    import {downloadBuffer} from "https://kairuz.github.io/acyoustic/sample-utils.js";
    import {SAMPLE_MODELS} from "./projects/lambda-project.js";
    import {Scheduler, SchedulerCallbacks} from "./scheduler.js";
    import BarDescriptorProducer from "./bar-descriptor-producer.js";


    const barDescriptorProducer = new BarDescriptorProducer();

    const runScheduler = () => {

      const visualsDiv = document.getElementById('visuals');
      const audioContext = new AudioContext();

      const sampleNames = Object.keys(SAMPLE_MODELS);

      const sampleBuffersPromise = Promise.all(Object.entries(SAMPLE_MODELS).map(([sampleName, {path}]) => {
        return downloadBuffer(audioContext, path);
      }));

      sampleBuffersPromise
          .then((sampleBuffers) => {

            const SamplingUi = (sampling, barDuration, earliestSamplingOffset) => {
              const sampleBuffer = sampleBuffers[sampleNames.indexOf(sampling.descriptor.sampleName)];

              const div = document.createElement('div');
              div.classList.add('samplingUiDiv');
              div.style.display = 'inline-block';
              div.style.position = 'relative';
              // div.style.position = 'absolute';
              div.style.margin = '4px';
              div.style.height = '20px';

              // div.style.top = '40px';
              // div.style.left = `${20 + Math.trunc(sampling.descriptor.offset / 1000) * 100}px`;
              // div.style.width = `${Math.max(100, Math.trunc(sampleBuffer.duration) * 100)}px`;
              div.style.width = `${Math.trunc(sampleBuffer.duration * 50)}px`;
              div.style.color = 'grey';
              div.style.outline = '1px solid lightgrey';

              // div.textContent = `${sampling.id}-${Math.trunc(sampling.timestamp)}`;
              div.textContent = `${Math.trunc(sampling.timestamp / 100) / 10}`;

              return {
                getSampling: () => sampling,
                getDiv: () => div,
                setAsStarted: () => {
                  div.style.color = 'black';
                  div.style.outline = '2px solid darkgreen';
                },
                setAsPlaying: () => {
                  // div.style.color = 'black';
                  div.style.outline = '4px solid lightgreen';
                  // div.style['background'] = 'linear-gradient(to left, salmon 50%, lightblue 50%) right';


                  div.style['background-position'] = 'right';
                  // div.style['transition'] = '.5s ease-out';

                  // div.clientHeight;
                  div.offsetHeight;

                  div.style['background'] = 'linear-gradient(to right, lightblue 50%, transparent 50%) left';
                  div.style['background-size'] = '200%';
                  const transitionDurationSecs = sampleBuffer.duration;
                  div.style['transition'] = `background ${transitionDurationSecs}s linear`;
// outline ${transitionDurationSecs}s linear,



                  // div.style['box-shadow'] = 'inset 100px 0 0 0 lightblue';
                  // div.style['transition'] = `all ease ${scheduler.sampleAudioBuffers[sampleNames.indexOf(sampling.descriptor.sampleName)].duration}s`;
                },
                setAsDone: () => {
                  // div.style.color = 'lightgrey';
                  div.style.outline = '2px solid orange';
                },
              }
            };

            const BarUi = (bar, samplings) => {
              const div = document.createElement('div');
              div.classList.add('barUiDiv');
              div.style.position = 'relative';
              div.style.margin = '20px';
              div.style.outline = '4px solid lightgrey';
              div.style['overflow'] = 'hidden';

              // div.style.height = 'auto';

              div.textContent = `${bar.id}-${Math.trunc(bar.timestamp)}-${bar.descriptor.duration}`;
              const samplingsDiv = document.createElement('div');
              samplingsDiv.classList.add('barUiSamplingsDiv');
              div.appendChild(samplingsDiv);


              const sampleNameDivs = new Map();

              const samplingUis = new Map();
              samplings.forEach((sampling) => {
                // const samplingUi = SamplingUi(sampling, bar.descriptor.duration, bar.descriptor.earliestSamplingOffset);
                const samplingUi = SamplingUi(sampling, bar.descriptor.duration, barDescriptorProducer.earliestSamplingOffset);
                samplingUis.set(sampling, samplingUi);

                if (sampleNameDivs.has(sampling.descriptor.sampleName)) {
                  sampleNameDivs.get(sampling.descriptor.sampleName).appendChild(samplingUi.getDiv());
                }
                else {
                  const sampleNameDiv = document.createElement('div');
                  sampleNameDiv.classList.add('sampleNameDiv');
                  sampleNameDiv.style.position = 'relative';
                  sampleNameDiv.style.margin = '10px';
                  const sampleNameDivNameDiv = document.createElement('div');
                  sampleNameDivNameDiv.classList.add('sampleNameDivNameDiv');
                  sampleNameDivNameDiv.style.position = 'absolute';
                  sampleNameDivNameDiv.textContent = sampling.descriptor.sampleName;
                  sampleNameDiv.appendChild(sampleNameDivNameDiv);
                  sampleNameDiv.appendChild(document.createElement('br'));
                  sampleNameDivs.set(sampling.descriptor.sampleName, sampleNameDiv);
                  samplingsDiv.appendChild(sampleNameDiv);
                  sampleNameDiv.appendChild(samplingUi.getDiv());
                }

              });
              return {
                getBar: () => bar,
                getSamplingUi: (sampling) => samplingUis.get(sampling),
                getDiv: () => div,
                getSamplingsDiv: () => samplingsDiv,
                setAsStarted: () => {
                  div.style.outline = '4px solid darkgreen';
                },
                setAsPlaying: () => {
                  div.style.outline = '4px solid green';
                },
                setAsDone: () => {
                  div.style['height'] = `${div.clientHeight}px`;
                  div.style['transition'] = 'height 0.5s ease, margin 0.5s ease, outline 0.2s ease';
                  // div.style['transition'] = 'all 0.5s ease';
                  div.style['overflow'] = 'hidden';

                  div.offsetHeight;
                  div.style['height'] = '0';
                  div.style['margin'] = '0 20px 0 20px';
                  div.style['outline'] = '4px solid transparent';
                  div.addEventListener('transitionend', (e) => {
                    if (e.propertyName === 'height') {
                      div.remove();
                    }
                  });
                }
              }
            };

            const barUis = new Map();
            pBarUis = barUis;
            const schedulerCallbacks = new SchedulerCallbacks(
                (bar, samplings) => {
                  console.log(`bar ${bar.id} samplings ${samplings.map((sampling) => sampling.id).join(',')} scheduled`);
                  const barUi = BarUi(bar, samplings);
                  visualsDiv.appendChild(barUi.getDiv());
                  barUis.set(bar, barUi);
                },
                (bar) => {
                  console.log(`bar ${bar.id} started`);
                  // const barUi = BarUi(bar);
                  // visualsDiv.appendChild(barUi.getDiv());
                  // barUis.set(bar, barUi);
                  const barUi = barUis.get(bar);
                  barUi.setAsPlaying();
                },
                (bar) => {
                  console.log(`bar ${bar.id} ended`);
                  const barUi = barUis.get(bar);
                  barUis.delete(bar);
                  barUi.setAsDone();
                  // setTimeout(() => barUi.getDiv().remove(), 1000);
                },
                (bar, sampling) => {
                  // console.log(`sampling ${sampling.id} bar ${bar.id} started`);
                  const barUi = barUis.get(bar);
                  const samplingUi = barUi.getSamplingUi(sampling);
                  samplingUi.setAsStarted();
                  setTimeout(() => samplingUi.setAsPlaying(), sampling.timestamp - scheduler.timer.currentTime);
                  // barUi.addSamplingsUi(sampling);
                },
                (bar, sampling) => {
                  // console.log(`sampling ${sampling.id} bar ${bar.id} ended`);
                  const barUi = barUis.get(bar);
                  const samplingUi = barUi.getSamplingUi(sampling);
                  samplingUi.setAsDone();
                  // barUi.removeSamplingsUi(sampling);
                },
            );

            pSampleBuffers = sampleBuffers;

            stopScheduler();
            const scheduler = new Scheduler(audioContext, barDescriptorProducer, sampleNames, sampleBuffers, schedulerCallbacks);
            pScheduler = scheduler;
          })
          .catch((err) => {
            console.log('err ', err);
            throw err;
          });

    };


    const stopScheduler = () => {
      pScheduler?.stop();
      const visualsDiv = document.getElementById('visuals');
      while (visualsDiv.firstChild) {
        visualsDiv.removeChild(visualsDiv.firstChild);
      }
    };

    window.addEventListener('load', () => {
      document.getElementById('start').addEventListener('click', () => runScheduler());
      document.getElementById('stop').addEventListener('click', () => stopScheduler());
    });

  </script>
</head>

<body>
<div>
  <input type="submit" id="start" value="start"/>
  <input type="submit" id="stop" value="stop"/>
</div>
<div id="visuals" style="width: 100%; height: 100%;">

</div>

</body>

</html>